<!-- product-edit-modal.component.html -->
<div class="product-modal">
    <div class="modal-header">
    <h2 mat-dialog-title>Edit: {{ editedProduct.name }}</h2>
    <button mat-icon-button class="close-btn" (click)="cancelDialog()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="modal-content">
    <!-- Basic Information Section -->
    <section class="section">
      <h3 class="section-title">Thông tin cơ bản</h3>
      
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field flex-2">
          <mat-label>Tên sản phẩm</mat-label>
          <input matInput [(ngModel)]="editedProduct.name" placeholder="Nhập tên sản phẩm" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Danh mục</mat-label>
          <mat-select [(ngModel)]="editedProduct.categoryId">
            <mat-option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Images Section -->
      <div class="image-upload-section">
        <label class="upload-label">Hình ảnh sản phẩm</label>
        <div class="image-upload-area">
          <input 
            type="file" 
            id="imageUpload" 
            multiple 
            (change)="onImagesSelected($event)" 
            accept="image/*" 
            #fileInput
            style="display: none;"
          />
          
          <div class="image-list" #imageListRef *ngIf="imagePreviews.length > 0" cdkDropList cdkDropListOrientation="vertical" (cdkDropListDropped)="dropImage($event)">
            <div class="image-list-item" *ngFor="let preview of imagePreviews; let i = index" cdkDrag>
              <div class="drag-handle" cdkDragHandle>
                <mat-icon>drag_indicator</mat-icon>
              </div>
              <div class="image-thumbnail">
                <img [src]="preview" alt="Preview" />
              </div>
              <div class="image-info">
                <span class="image-index">Ảnh {{ i + 1 }}</span>
                <span class="image-hint" *ngIf="i === 0">Ảnh bìa</span>
              </div>
              <button mat-icon-button class="delete-btn" (click)="removeImage(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <div class="add-image-btn" *ngIf="imagePreviews.length > 0" (click)="fileInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Thêm ảnh</span>
          </div>

          <div class="empty-upload" *ngIf="imagePreviews.length === 0" (click)="fileInput.click()">
            <mat-icon>cloud_upload</mat-icon>
            <p>Thêm ít nhất 3 hình ảnh trong mô tả sản phẩm</p>
            <button mat-stroked-button color="primary">Chọn hình ảnh</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Product Details Section -->
    <section class="section">
      <h3 class="section-title">Chi tiết sản phẩm</h3>
      
      <div class="details-list">
        <div *ngFor="let detail of editedProduct.details; let i = index" class="detail-item">
          <mat-form-field appearance="outline" class="detail-title">
            <mat-label>Tiêu đề</mat-label>
            <input matInput [(ngModel)]="editedProduct.details[i].title" placeholder="VD: Chất liệu" />
          </mat-form-field>

          <div class="detail-content rich-text-field">
            <label class="rich-text-label">Nội dung</label>
            <div class="rich-text-toolbar">
              <button type="button" mat-icon-button (click)="execCommand('bold', i)" matTooltip="Bold">
                <mat-icon>format_bold</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('italic', i)" matTooltip="Italic">
                <mat-icon>format_italic</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('underline', i)" matTooltip="Underline">
                <mat-icon>format_underlined</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('insertUnorderedList', i)" matTooltip="Bullet List">
                <mat-icon>format_list_bulleted</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('insertOrderedList', i)" matTooltip="Numbered List">
                <mat-icon>format_list_numbered</mat-icon>
              </button>
              <div class="toolbar-divider"></div>
              <button type="button" mat-icon-button (click)="insertImageInDetail(i)" matTooltip="Insert Image">
                <mat-icon>image</mat-icon>
              </button>
              <input
                type="file"
                #detailImageInput
                accept="image/*"
                (change)="onDetailImageSelected($event, i)"
                style="display: none;"
              />
            </div>
            <div
              #richTextEditor
              class="rich-text-editor"
              contenteditable="true"
              (input)="onContentChange($event, i)"
              placeholder="Mô tả chi tiết..."
            ></div>
          </div>

          <button mat-icon-button color="warn" (click)="removeDetail(i)" class="remove-btn">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <button mat-stroked-button (click)="addDetail()" class="add-btn">
        <mat-icon>add</mat-icon>
        Thêm chi tiết
      </button>
    </section>

    <!-- Size Guide Section -->
    <section class="section">
      <h3 class="section-title">Hướng dẫn chọn size (tùy chọn)</h3>

      <div class="image-upload-section">
        <label class="upload-label">Tải lên hình ảnh hướng dẫn chọn size</label>
        <div class="image-upload-area">
          <input
            type="file"
            id="sizeGuideUpload"
            (change)="onSizeGuideSelected($event)"
            accept="image/*"
            #sizeGuideInput
            style="display: none;"
          />

          <div class="image-grid" *ngIf="sizeGuidePreview">
            <div class="image-item">
              <img [src]="sizeGuidePreview" alt="Size Guide" />
              <div class="image-overlay">
                <button mat-icon-button class="delete-btn" (click)="removeSizeGuide()">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <div class="empty-upload" *ngIf="!sizeGuidePreview" (click)="sizeGuideInput.click()">
            <mat-icon>straighten</mat-icon>
            <p>Tải lên bảng hướng dẫn chọn size</p>
            <button mat-stroked-button color="primary">Chọn hình ảnh</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <h3 class="section-title">Khoảng giá sản phẩm</h3>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Giá bán</mat-label>
            <input matInput type="number" [(ngModel)]="editedProduct.price" placeholder="0" />
            <span matTextSuffix>₫&nbsp;</span>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Giá gốc (tùy chọn)</mat-label>
            <input matInput type="number" [(ngModel)]="editedProduct.originalPrice" placeholder="0" />
            <span matTextSuffix>₫&nbsp;</span>
            <mat-hint *ngIf="getDiscount() > 0">Giảm {{ getDiscount() }}%</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Số lượng bán</mat-label>
            <input matInput type="number" [(ngModel)]="editedProduct.soldCount" placeholder="0" />
          </mat-form-field>
        </div>
    </section>

    <!-- Variants / Sales Info Section (Shopify-style) -->
    <section class="section variants-section">
      <div class="section-header" style="display:flex; align-items:center; justify-content:space-between;">
        <h3 class="section-title">Thông tin bán hàng</h3>
        <mat-slide-toggle [(ngModel)]="hasVariants" (change)="onVariantsToggle()">
          Phân loại hàng
        </mat-slide-toggle>
      </div>

      <div *ngIf="hasVariants" class="variants-config">
        <div class="variant-actions">
          <button mat-stroked-button color="primary" (click)="addVariant()">
            <mat-icon>add</mat-icon>
            Thêm phân loại
          </button>
        </div>

      <!-- Variant Options Builder (like create modal) -->
      <div class="variant-options" style="margin-top:16px;">
        <div class="options-list" *ngFor="let opt of variantOptions; let oi = index" style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <mat-form-field appearance="outline" class="option-name" style="flex:1; min-width:150px;">
            <mat-label>Loại phân loại</mat-label>
            <mat-select [(ngModel)]="variantOptions[oi].name" (ngModelChange)="updateVariantsFromOptions()">
              <mat-option *ngFor="let type of getAvailableVariantTypes(oi)" [value]="type">
                {{ type }}
              </mat-option>
              <!-- Keep current value visible if already selected -->
              <mat-option *ngIf="variantOptions[oi].name && !getAvailableVariantTypes(oi).includes(variantOptions[oi].name)" [value]="variantOptions[oi].name">
                {{ variantOptions[oi].name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="option-values" style="flex:2; display:flex; gap:8px; align-items:center;">
            <mat-chip-listbox>
              <mat-chip-option
                *ngFor="let value of opt.values; let j = index"
                [value]="value"
                [removable]="true"
                (removed)="removeOptionValue(oi, j)">
                {{ value.name }}
                <mat-icon matChipRemove>cancel</mat-icon>
              </mat-chip-option>
            </mat-chip-listbox>

            <mat-form-field appearance="outline" class="add-value-field" style="width:220px;">
              <input matInput placeholder="Thêm giá trị" [(ngModel)]="newOptionValues[oi]" (keyup.enter)="addOptionValue(oi)" />
              <button mat-icon-button matSuffix (click)="addOptionValue(oi)">
                <mat-icon>add</mat-icon>
              </button>
            </mat-form-field>
          </div>

          <button mat-icon-button color="warn" (click)="removeVariantOption(oi)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <div class="options-actions">
          <button mat-stroked-button color="primary" (click)="addVariantOption()" [disabled]="variantOptions.length >= 3">
            <mat-icon>add</mat-icon> Thêm thuộc tính
          </button>
        </div>
      </div>

      <!-- Auto-fill Template -->
      <div class="auto-fill-template" *ngIf="productVariants.length > 0">
        <div class="template-header">
          <h4>Điền nhanh giá trị</h4>
          <span class="template-hint">Điền giá trị mẫu và nhấn nút để áp dụng cho các ô trống</span>
        </div>
        <div class="template-inputs">
          <mat-form-field appearance="outline" class="template-input">
            <mat-label>Giá</mat-label>
            <input matInput type="number" [(ngModel)]="variantTemplate.price" />
            <span matTextSuffix>₫&nbsp;</span>
          </mat-form-field>
          <mat-form-field appearance="outline" class="template-input">
            <mat-label>Giá gốc</mat-label>
            <input matInput type="number" [(ngModel)]="variantTemplate.originalPrice" />
            <span matTextSuffix>₫&nbsp;</span>
          </mat-form-field>
          <mat-form-field appearance="outline" class="template-input">
            <mat-label>Kho hàng</mat-label>
            <input matInput type="number" [(ngModel)]="variantTemplate.stock" />
          </mat-form-field>
          <mat-form-field appearance="outline" class="template-input">
            <mat-label>Đã bán</mat-label>
            <input matInput type="number" [(ngModel)]="variantTemplate.soldCount" />
          </mat-form-field>
          <mat-form-field appearance="outline" class="template-input">
            <mat-label>SKU</mat-label>
            <input matInput [(ngModel)]="variantTemplate.sku" placeholder="Mã SKU" />
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="fillEmptyVariantValues()" class="fill-btn">
            <mat-icon>auto_fix_high</mat-icon>
            Điền giá trị trống
          </button>
        </div>
      </div>

      <!-- Variant List Table -->
      <div class="variant-list">
        <div class="variant-table">
          <table mat-table [dataSource]="productVariants" class="variants-table">
            <!-- Variant Column -->
            <ng-container matColumnDef="variant">
              <th mat-header-cell *matHeaderCellDef>Phân loại hàng</th>
              <td mat-cell *matCellDef="let variant">
                <div class="variant-name">
                  <span class="variant-badge" *ngFor="let attr of variant.attributes">
                    {{ attr.value }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Price Column -->
            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>Giá</th>
              <td mat-cell *matCellDef="let variant">
                <mat-form-field appearance="outline" class="table-input">
                  <input matInput type="number" [(ngModel)]="variant.price" />
                  <span matTextSuffix>₫&nbsp;</span>
                </mat-form-field>
              </td>
            </ng-container>

            <!-- Original Price Column -->
            <ng-container matColumnDef="originalPrice">
              <th mat-header-cell *matHeaderCellDef>Giá Gốc</th>
              <td mat-cell *matCellDef="let variant">
                <mat-form-field appearance="outline" class="table-input">
                  <input matInput type="number" [(ngModel)]="variant.originalPrice" />
                  <span matTextSuffix>₫&nbsp;</span>
                </mat-form-field>
              </td>
            </ng-container>

            <!-- Stock Column -->
            <ng-container matColumnDef="stock">
              <th mat-header-cell *matHeaderCellDef>Kho hàng</th>
              <td mat-cell *matCellDef="let variant">
                <mat-form-field appearance="outline" class="table-input">
                  <input matInput type="number" [(ngModel)]="variant.stock" />
                </mat-form-field>
              </td>
            </ng-container>

            <!-- Sold Count Column -->
            <ng-container matColumnDef="soldCount">
              <th mat-header-cell *matHeaderCellDef>Đã bán</th>
              <td mat-cell *matCellDef="let variant">
                <mat-form-field appearance="outline" class="table-input">
                  <input matInput type="number" [(ngModel)]="variant.soldCount" />
                </mat-form-field>
              </td>
            </ng-container>

            <!-- SKU Column -->
            <ng-container matColumnDef="sku">
              <th mat-header-cell *matHeaderCellDef>SKU phân loại</th>
              <td mat-cell *matCellDef="let variant">
                <mat-form-field appearance="outline" class="table-input">
                  <input matInput [(ngModel)]="variant.sku" placeholder="Tùy chọn" />
                </mat-form-field>
              </td>
            </ng-container>

            <!-- Variation Image -->
            <ng-container matColumnDef="variationImage">
              <th mat-header-cell *matHeaderCellDef>Hình ảnh</th>
              <td mat-cell *matCellDef="let variant; let i = index">
                <div class="variation-image-cell">
                  <div class="image-preview" *ngIf="getVariationImagePreview(i)">
                    <img [src]="getVariationImagePreview(i)" alt="Variation preview" />
                    <button mat-icon-button (click)="removeVariationImage(i)" class="remove-image-btn">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                  <div class="no-image" *ngIf="!getVariationImagePreview(i)">
                    <input 
                      type="file" 
                      #variantFileInput
                      accept="image/*" 
                      (change)="onVariationImageSelected($event, i)"
                      style="display: none;"
                    />
                    <button mat-icon-button (click)="variantFileInput.click()" class="upload-btn">
                      <mat-icon>add_photo_alternate</mat-icon>
                    </button>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let variant; let i = index">
                <button mat-icon-button (click)="removeVariant(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </div>
      </div>

      <!-- Simple Inventory (No Variants) -->
      <div *ngIf="!hasVariants" class="simple-inventory" style="margin-top:16px;">
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Kho hàng</mat-label>
            <input matInput type="number" [(ngModel)]="editedProduct.stock" placeholder="0" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>SKU</mat-label>
            <input matInput [(ngModel)]="editedProduct.sku" placeholder="Mã sản phẩm" />
          </mat-form-field>
        </div>
      </div>
    </section>


  </mat-dialog-content>

  <!-- Footer Actions -->
    <mat-dialog-actions class="modal-actions">
    <div class="actions-left">
      <button mat-button (click)="cancelDialog()">Hủy</button>
    </div>
    <div class="actions-right">
      <button mat-raised-button color="primary" (click)="save()" [disabled]="isSaving">
        <mat-icon *ngIf="!isSaving">check</mat-icon>
        <mat-progress-spinner *ngIf="isSaving" diameter="20" mode="indeterminate"></mat-progress-spinner>
        &nbsp;Cập nhật
      </button>
    </div>
  </mat-dialog-actions>
</div>
