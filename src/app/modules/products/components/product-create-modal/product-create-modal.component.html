<!-- product-create-modal-enhanced.component.html -->
<div class="product-modal">
  <div class="modal-header">
    <h2 mat-dialog-title>Thêm sản phẩm mới</h2>
    <button mat-icon-button class="close-btn" (click)="cancel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="modal-content">
    <!-- Basic Information Section -->
    <section class="section">
      <h3 class="section-title">Thông tin cơ bản</h3>
      
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field flex-2">
          <mat-label>Tên sản phẩm</mat-label>
          <input matInput [(ngModel)]="newProduct.name" placeholder="Nhập tên sản phẩm" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Danh mục</mat-label>
          <mat-select [(ngModel)]="newProduct.categoryId">
            <mat-option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Images Section -->
      <div class="image-upload-section">
        <label class="upload-label">Hình ảnh sản phẩm ({{ imagePreviews.length }}/{{ maxImages }})</label>
        <div class="image-upload-area">
          <input
            type="file"
            id="imageUpload"
            multiple
            (change)="onImagesSelected($event)"
            accept="image/*"
            #fileInput
            style="display: none;"
          />

          <div class="image-list" #imageListRef *ngIf="imagePreviews.length > 0" cdkDropList cdkDropListOrientation="vertical" (cdkDropListDropped)="dropImage($event)">
            <div class="image-list-item" *ngFor="let preview of imagePreviews; let i = index" cdkDrag>
              <div class="drag-handle" cdkDragHandle>
                <mat-icon>drag_indicator</mat-icon>
              </div>
              <div class="image-thumbnail">
                <img [src]="preview" alt="Preview" />
              </div>
              <div class="image-info">
                <span class="image-index">Ảnh {{ i + 1 }}</span>
                <span class="image-hint" *ngIf="i === 0">Ảnh bìa</span>
              </div>
              <button mat-icon-button class="delete-btn" (click)="removeImage(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <div class="add-image-btn" *ngIf="imagePreviews.length > 0 && imagePreviews.length < maxImages" (click)="fileInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            <span>Thêm ảnh (còn {{ maxImages - imagePreviews.length }})</span>
          </div>
          <div class="max-images-reached" *ngIf="imagePreviews.length >= maxImages">
            <mat-icon>check_circle</mat-icon>
            <span>Đã đạt tối đa {{ maxImages }} ảnh</span>
          </div>

          <div class="empty-upload" *ngIf="imagePreviews.length === 0" (click)="fileInput.click()">
            <mat-icon>cloud_upload</mat-icon>
            <p>Thêm hình ảnh trong mô tả sản phẩm (tối đa {{ maxImages }} ảnh)</p>
            <button mat-stroked-button color="primary">Chọn hình ảnh</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Product Details Section -->
    <section class="section">
      <h3 class="section-title">Chi tiết sản phẩm</h3>
      
      <div class="details-list">
        <div *ngFor="let detail of newProduct.details; let i = index" class="detail-item">
          <mat-form-field appearance="outline" class="detail-title">
            <mat-label>Tiêu đề</mat-label>
            <input matInput [(ngModel)]="newProduct.details[i].title" placeholder="VD: Chất liệu" />
          </mat-form-field>

          <div class="detail-content rich-text-field">
            <label class="rich-text-label">Nội dung</label>
            <div class="rich-text-toolbar">
              <button type="button" mat-icon-button (click)="execCommand('bold', i)" matTooltip="Bold">
                <mat-icon>format_bold</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('italic', i)" matTooltip="Italic">
                <mat-icon>format_italic</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('underline', i)" matTooltip="Underline">
                <mat-icon>format_underlined</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('insertUnorderedList', i)" matTooltip="Bullet List">
                <mat-icon>format_list_bulleted</mat-icon>
              </button>
              <button type="button" mat-icon-button (click)="execCommand('insertOrderedList', i)" matTooltip="Numbered List">
                <mat-icon>format_list_numbered</mat-icon>
              </button>
              <div class="toolbar-divider"></div>
              <button type="button" mat-icon-button (click)="insertImageInDetail(i)" matTooltip="Insert Image">
                <mat-icon>image</mat-icon>
              </button>
              <input
                type="file"
                #detailImageInput
                accept="image/*"
                (change)="onDetailImageSelected($event, i)"
                style="display: none;"
              />
            </div>
            <div
              #richTextEditor
              class="rich-text-editor"
              contenteditable="true"
              (input)="onContentChange($event, i)"
              placeholder="Mô tả chi tiết..."
            ></div>
          </div>

          <button mat-icon-button color="warn" (click)="removeDetail(i)" class="remove-btn">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <button mat-stroked-button (click)="addDetail()" class="add-btn">
        <mat-icon>add</mat-icon>
        Thêm chi tiết
      </button>
    </section>

    <!-- Size Guide Section -->
    <section class="section">
      <h3 class="section-title">Hướng dẫn chọn size (tùy chọn)</h3>

      <div class="image-upload-section">
        <label class="upload-label">Tải lên hình ảnh hướng dẫn chọn size</label>
        <div class="image-upload-area">
          <input
            type="file"
            id="sizeGuideUpload"
            (change)="onSizeGuideSelected($event)"
            accept="image/*"
            #sizeGuideInput
            style="display: none;"
          />

          <div class="image-grid" *ngIf="sizeGuidePreview">
            <div class="image-item">
              <img [src]="sizeGuidePreview" alt="Size Guide" />
              <div class="image-overlay">
                <button mat-icon-button class="delete-btn" (click)="removeSizeGuide()">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <div class="empty-upload" *ngIf="!sizeGuidePreview" (click)="sizeGuideInput.click()">
            <mat-icon>straighten</mat-icon>
            <p>Tải lên bảng hướng dẫn chọn size</p>
            <button mat-stroked-button color="primary">Chọn hình ảnh</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <h3 class="section-title">Khoảng giá sản phẩm</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Giá bán</mat-label>
          <input matInput type="number" [(ngModel)]="newProduct.price" placeholder="0" />
          <span matTextSuffix>₫&nbsp;</span>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Giá gốc (tùy chọn)</mat-label>
          <input matInput type="number" [(ngModel)]="newProduct.originalPrice" placeholder="0" />
          <span matTextSuffix>₫&nbsp;</span>
          <mat-hint *ngIf="getDiscount() > 0">Giảm {{ getDiscount() }}%</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Số lượng bán</mat-label>
          <input matInput type="number" [(ngModel)]="newProduct.soldCount" placeholder="0" />
        </mat-form-field>
      </div>
    </section>

    <!-- Variants Section (Shopify-style) -->
    <section class="section variants-section">
      <div class="section-header">
        <h3 class="section-title">Thông tin bán hàng</h3>
        <mat-slide-toggle [(ngModel)]="hasVariants" (change)="onVariantsToggle()">
          Phân loại hàng
        </mat-slide-toggle>
      </div>

      <div *ngIf="hasVariants" class="variants-config">
        <!-- Variant Options Configuration -->
        <div class="variant-options" cdkDropList (cdkDropListDropped)="dropVariantOption($event)">
          <div *ngFor="let option of variantOptions; let i = index" class="variant-option" cdkDrag>
            <div class="option-header">
              <div class="option-drag-handle" cdkDragHandle>
                <mat-icon>drag_indicator</mat-icon>
              </div>
              <mat-form-field appearance="outline" class="option-name">
                <mat-label>Loại phân loại {{ i + 1 }}</mat-label>
                <mat-select [(ngModel)]="option.name" (ngModelChange)="updateVariants()">
                  <mat-option *ngFor="let type of getAvailableVariantTypes(i)" [value]="type">
                    {{ type }}
                  </mat-option>
                  <!-- Keep current value visible if already selected -->
                  <mat-option *ngIf="option.name && !getAvailableVariantTypes(i).includes(option.name)" [value]="option.name">
                    {{ option.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <button
                mat-icon-button
                color="warn"
                (click)="removeVariantOption(i)"
                *ngIf="variantOptions.length > 1"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <!-- Option Values -->
            <div class="option-values">
              <div class="value-chips-container" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="dropOptionValue($event, i)">
                <div class="value-chip" *ngFor="let value of option.values; let j = index" cdkDrag>
                  <span class="chip-text">{{ value.name }}</span>
                  <button mat-icon-button class="chip-remove" (click)="removeOptionValue(i, j)">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </div>
              </div>

              <!-- Add Value Input -->
              <div class="add-value-input">
                <mat-form-field appearance="outline" class="value-input">
                  <mat-label>Thêm tùy chọn</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="newOptionValues[i]"
                    (keyup.enter)="addOptionValue(i)"
                    placeholder="Nhập và Enter"
                  />
                </mat-form-field>                
                <button mat-icon-button color="primary" (click)="addOptionValue(i)">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <button
            mat-stroked-button
            (click)="addVariantOption()"
            class="add-btn"
            *ngIf="variantOptions.length < 3"
          >
            <mat-icon>add</mat-icon>
            Thêm nhóm phân loại {{ variantOptions.length + 1 }}
          </button>
        </div>

        <!-- Auto-fill Template -->
        <div class="auto-fill-template" *ngIf="productVariants.length > 0">
          <div class="template-header">
            <h4>Điền nhanh giá trị</h4>
            <span class="template-hint">Điền giá trị mẫu và nhấn nút để áp dụng cho các ô trống</span>
          </div>
          <div class="template-inputs">
            <mat-form-field appearance="outline" class="template-input">
              <mat-label>Giá</mat-label>
              <input matInput type="number" [(ngModel)]="variantTemplate.price" />
              <span matTextSuffix>₫&nbsp;</span>
            </mat-form-field>
            <mat-form-field appearance="outline" class="template-input">
              <mat-label>Giá gốc</mat-label>
              <input matInput type="number" [(ngModel)]="variantTemplate.originalPrice" />
              <span matTextSuffix>₫&nbsp;</span>
            </mat-form-field>
            <mat-form-field appearance="outline" class="template-input">
              <mat-label>Kho hàng</mat-label>
              <input matInput type="number" [(ngModel)]="variantTemplate.stock" />
            </mat-form-field>
            <mat-form-field appearance="outline" class="template-input">
              <mat-label>SKU</mat-label>
              <input matInput [(ngModel)]="variantTemplate.sku" placeholder="Mã SKU" />
            </mat-form-field>
            <button mat-raised-button color="primary" (click)="fillEmptyVariantValues()" class="fill-btn">
              Hoàn thành các ô trống
            </button>
          </div>
        </div>

        <!-- Variant List Table -->
        <div class="variant-list" *ngIf="productVariants.length > 0">
          <div class="list-header">
            <h4>Danh sách phân loại hàng</h4>
          </div>

          <div class="variant-table" cdkDropList (cdkDropListDropped)="dropVariant($event)">
            <table mat-table [dataSource]="productVariants" class="variants-table">
              <!-- Drag Handle Column -->
              <ng-container matColumnDef="drag">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let variant">
                  <div class="drag-handle" cdkDragHandle>
                    <mat-icon>drag_indicator</mat-icon>
                  </div>
                </td>
              </ng-container>

              <!-- Variant Column -->
              <ng-container matColumnDef="variant">
                <th mat-header-cell *matHeaderCellDef>Phân loại hàng</th>
                <td mat-cell *matCellDef="let variant">
                  <div class="variant-name">
                    <span class="variant-badge" *ngFor="let attr of variant.attributes">
                      {{ attr.value }}
                    </span>
                  </div>
                </td>
              </ng-container>

              <!-- Price Column -->
              <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef>Giá</th>
                <td mat-cell *matCellDef="let variant">
                  <mat-form-field appearance="outline" class="table-input">
                    <input matInput type="number" [(ngModel)]="variant.price" />
                    <span matTextSuffix>₫&nbsp;</span>
                  </mat-form-field>
                </td>
              </ng-container>


              <!-- Original Price Column -->
              <ng-container matColumnDef="originalPrice">
                <th mat-header-cell *matHeaderCellDef>Giá Gốc</th>
                <td mat-cell *matCellDef="let variant">
                  <mat-form-field appearance="outline" class="table-input">
                    <input matInput type="number" [(ngModel)]="variant.originalPrice" />
                    <span matTextSuffix>₫&nbsp;</span>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Stock Column -->
              <ng-container matColumnDef="stock">
                <th mat-header-cell *matHeaderCellDef>Kho hàng</th>
                <td mat-cell *matCellDef="let variant">
                  <mat-form-field appearance="outline" class="table-input">
                    <input matInput type="number" [(ngModel)]="variant.stock" />
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- SKU Column -->
              <ng-container matColumnDef="sku">
                <th mat-header-cell *matHeaderCellDef>SKU phân loại</th>
                <td mat-cell *matCellDef="let variant">
                  <mat-form-field appearance="outline" class="table-input">
                    <input matInput [(ngModel)]="variant.sku" placeholder="Tùy chọn" />
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Variation Image -->
              <ng-container matColumnDef="variationImage">
                <th mat-header-cell *matHeaderCellDef>Hình ảnh</th>
                <td mat-cell *matCellDef="let variant; let i = index">
                  <div class="variation-image-cell">
                    <div class="image-preview" *ngIf="getVariationImagePreview(i)">
                      <img [src]="getVariationImagePreview(i)" alt="Variation preview" />
                      <button mat-icon-button (click)="removeVariationImage(i)" class="remove-image-btn">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                    <div class="no-image" *ngIf="!getVariationImagePreview(i)">
                      <input 
                        type="file" 
                        #variantFileInput
                        accept="image/*" 
                        (change)="onVariationImageSelected($event, i)"
                        style="display: none;"
                      />
                      <button mat-icon-button (click)="variantFileInput.click()" class="upload-btn">
                        <mat-icon>add_photo_alternate</mat-icon>
                      </button>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let variant; let i = index">
                  <button mat-icon-button (click)="removeVariant(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" cdkDrag></tr>
            </table>
          </div>

          <div class="variant-warning" *ngIf="productVariants.length === 0">
            <mat-icon>info</mat-icon>
            <p>Không thể tìm ví sản phẩm dàng có 1 tối cần được chỉnh sửa. 
              <a href="#" (click)="$event.preventDefault()">Chỉnh sửa ngay</a>
            </p>
          </div>
        </div>
      </div>

      <!-- Simple Inventory (No Variants) -->
      <div *ngIf="!hasVariants" class="simple-inventory">
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Kho hàng</mat-label>
            <input matInput type="number" [(ngModel)]="newProduct.stock" placeholder="0" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>SKU</mat-label>
            <input matInput [(ngModel)]="newProduct.sku" placeholder="Mã sản phẩm" />
          </mat-form-field>
        </div>
      </div>
    </section>
  </mat-dialog-content>

  <!-- Footer Actions -->
  <mat-dialog-actions class="modal-actions">
    <div class="actions-left">
      <button mat-button (click)="cancel()">Hủy</button>
    </div>
    <div class="actions-right">
      <button mat-stroked-button (click)="saveAndHide()">
        Lưu & Ẩn
      </button>
      <button mat-raised-button color="primary" (click)="create()">
        <mat-icon>check</mat-icon>
        Lưu & Hiển thị
      </button>
    </div>
  </mat-dialog-actions>
</div>